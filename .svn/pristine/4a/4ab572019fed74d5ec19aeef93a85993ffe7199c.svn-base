@{
    ViewBag.Title = "Index Central POS";
    var userId = "";
    var partyTypeId = "";
    var partyId = 0;
    if (Session["user_au_id"] != null)
    {
        userId = Session["user_au_id"].ToString();
        partyTypeId = Session["party_type_id"].ToString();
        partyId = Convert.ToInt32(Session["party_id"].ToString());
    }


}

<script type="text/javascript">
    var userId = @userId;
    var partyTypeId = @partyTypeId;
    var partyId = @partyId;

    $(document).ready(function () {
        $('#base').addClass('animated zoomIn');

        @*var todayDate = kendo.toString(kendo.parseDate(new Date()), 'dd/MM/yyyy');
        $("#requisition_date").val(todayDate);

        function lineBreaker (str, isXhtml) {
            var breakTag = (isXhtml || typeof isXhtml === 'undefined') ? '<br />' : '<br>';
            return (str + '').replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g, '$1'+ breakTag +'$2');
        }

        Loading(true);
        $.ajax({
            type: "GET",
            url: "@UrlConfig.Action("GetAvailablePromotions", "PromotionActivity")",
            dataType: "json",
            success: function (data) {
                Loading(false);
                //console.log(data);

                var listData = "";

                $.each(data, function (key, obj) {
                    listData += '<div class="row">';
                    listData += '<div class="panel panel-info">';
                    listData += '<div class="panel-heading">'+obj.titel+'</div>';
                    listData += '<div class="panel-body">';
                    listData += '<p>'+lineBreaker(obj.promotion_description)+'</p>';
                    listData += '</div>';
                    listData += '</div>';
                    listData += '</div>';
                });

                $("#available_promotions").append(listData);

                $("#available_promotions").hide();
                $("#available_promotions").slideDown(800);
            }

        });

        function yourfunction() {

            $("#available_promotions").empty();

            function lineBreaker (str, isXhtml) {
                var breakTag = (isXhtml || typeof isXhtml === 'undefined') ? '<br />' : '<br>';
                return (str + '').replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g, '$1'+ breakTag +'$2');
            }

            Loading(true);
            $.ajax({
                type: "GET",
                url: "@UrlConfig.Action("GetAvailablePromotions", "PromotionActivity")",
                dataType: "json",
                success: function (data) {
                    Loading(false);
                    //console.log(data);

                    var listData = "";

                    $.each(data, function (key, obj) {
                        listData += '<div class="row">';
                        listData += '<div class="panel panel-info">';
                        listData += '<div class="panel-heading">'+obj.titel+'</div>';
                        listData += '<div class="panel-body">';
                        listData += '<p>'+lineBreaker(obj.promotion_description)+'</p>';
                        listData += '</div>';
                        listData += '</div>';
                        listData += '</div>';
                    });

                    $("#available_promotions").append(listData);

                    $("#available_promotions").hide();
                    $("#available_promotions").slideUp(800);
                    $("#available_promotions").slideDown(800);
                }

            });
        }

        window.setInterval(yourfunction, 60000);*@
    });
</script>

<div class="col-md-12 widget-body" id="context">
    <div class="row">
        <div class="col-md-9">
            <div class="row">
                <div class="panel panel-success">
                    <div class="panel-heading">POS Information</div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="col-md-2">
                                    <label for="party_type_id">Party Type</label>
                                </div>
                                <div class="col-md-3">
                                    <input id="party_type_id" name="party_type_id" />
                                </div>
                                <div class="col-md-1"></div>
                                <div class="col-md-2">
                                    <label for="party_id">Party</label>
                                </div>
                                <div class="col-md-3">
                                    <input id="party_id" name="party_id" />
                                </div>
                                <div class="col-md-1"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="col-md-2">
                                    <label for="customer_name">Customer Name&nbsp;<i class="fa fa-asterisk fieldRequired"></i></label>
                                </div>
                                <div class="col-md-3">
                                    <input id="customer_name" name="customer_name" class="k-textbox" />
                                </div>
                                <div class="col-md-1"></div>
                                <div class="col-md-2">
                                    <label for="address">Address&nbsp;<i class="fa fa-asterisk fieldRequired"></i></label>
                                </div>
                                <div class="col-md-3">
                                    <input id="address" name="address" class="k-textbox" />
                                </div>
                                <div class="col-md-1"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="col-md-2">
                                    <label for="mobile_no">Mobile No&nbsp;<i class="fa fa-asterisk fieldRequired"></i></label>
                                </div>
                                <div class="col-md-3">
                                    <input id="mobile_no" name="mobile_no" class="k-textbox" />
                                </div>
                                <div class="col-md-1"></div>
                                <div class="col-md-2">
                                    <label for="from_warehouse_id">From Warehouse</label>
                                </div>
                                <div class="col-md-3">
                                    <input id="from_warehouse_id" name="from_warehouse_id" />
                                </div>
                                <div class="col-md-1"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="col-md-2">
                                    <label for="remarks">Remarks</label>
                                </div>
                                <div class="col-md-3">
                                    <input id="remarks" name="remarks" class="k-textbox" />
                                </div>
                                <div class="col-md-1"></div>
                                <div class="col-md-2">
                                    <label for="to_warehouse_id">To Warehouse</label>
                                </div>
                                <div class="col-md-3">
                                    <input id="to_warehouse_id" name="to_warehouse_id" />
                                </div>
                                <div class="col-md-1"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="panel panel-success">
                    <div class="panel-heading">Product List</div>
                    <div class="panel-body">
                        <div class="row" id="daynamicPanel">
                            <div class="col-md-12">
                                <div class="col-md-2">
                                    <label for="scan_imei">Scan Imei</label>
                                </div>
                                <div class="col-md-3">
                                    <input id="scan_imei" name="scan_imei" class="k-textbox" />
                                </div>
                                <div class="col-md-1"></div>
                            </div>
                        </div>
                        <br />
                        <div id="RequisitionDetailsGrid"></div>
                        <br />
                        <div class="group-box">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="col-md-2">
                                        <label for="amount">Amount</label>
                                    </div>
                                    <div class="col-md-3">
                                        <input id="amount" name="amount" class="k-textbox" disabled />
                                    </div>
                                    <div class="col-md-1"></div>
                                    <div class="col-md-2">

                                    </div>
                                    <div class="col-md-3">

                                    </div>
                                    <div class="col-md-1"></div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="col-md-2">
                                        <label for="vat_pcnt">VAT (%)</label>
                                    </div>
                                    <div class="col-md-3">
                                        <input id="vat_pcnt" name="vat_pcnt" value="15" class="k-textbox" disabled />
                                    </div>
                                    <div class="col-md-1"></div>
                                    <div class="col-md-2">

                                    </div>
                                    <div class="col-md-3">

                                    </div>
                                    <div class="col-md-1"></div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="col-md-2">
                                        <label for="amount_with_vat">Amount with VAT</label>
                                    </div>
                                    <div class="col-md-3">
                                        <input id="amount_with_vat" name="amount_with_vat" class="k-textbox" disabled />
                                    </div>
                                    <div class="col-md-1"></div>
                                    <div class="col-md-2">

                                    </div>
                                    <div class="col-md-3">

                                    </div>
                                    <div class="col-md-1"></div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="col-md-2">
                                        <label for="discount_pcnt">Discount (%)</label>
                                    </div>
                                    <div class="col-md-3">
                                        <input id="discount_pcnt" name="discount_pcnt" class="k-textbox" value="0" />
                                    </div>
                                    <div class="col-md-1"></div>
                                    <div class="col-md-2">
                                        <div class="col-md-3">
                                            <div class="col-md-1"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="col-md-2">
                                        <label for="discount_amount">Discount Amount</label>
                                    </div>
                                    <div class="col-md-3">
                                        <input id="discount_amount" name="discount_amount" class="k-textbox" value="0" />
                                    </div>
                                    <div class="col-md-1"></div>
                                    <div class="col-md-2">
                                        <div class="col-md-3">
                                            <div class="col-md-1"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="col-md-2">
                                        <label for="net_amount">Net Amount</label>
                                    </div>
                                    <div class="col-md-3">
                                        <input id="net_amount" name="net_amount" class="k-textbox" disabled />
                                    </div>
                                    <div class="col-md-1"></div>
                                    <div class="col-md-2">

                                    </div>
                                    <div class="col-md-3">

                                    </div>
                                    <div class="col-md-1"></div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="col-md-2">
                                        <label for="net_amount">Paid Amount&nbsp;<i class="fa fa-asterisk fieldRequired"></i></label>
                                    </div>
                                    <div class="col-md-3">
                                        <input id="paid_amount" name="paid_amount" class="k-textbox" />
                                    </div>
                                    <div class="col-md-1"></div>
                                    <div class="col-md-2">

                                    </div>
                                    <div class="col-md-3">

                                    </div>
                                    <div class="col-md-1"></div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="col-md-2">
                                        <label for="net_amount">Return Amount&nbsp;<i class="fa fa-asterisk fieldRequired"></i></label>
                                    </div>
                                    <div class="col-md-3">
                                        <input id="return_amount" name="return_amount" class="k-textbox" disabled />
                                    </div>
                                    <div class="col-md-1"></div>
                                    <div class="col-md-2">

                                    </div>
                                    <div class="col-md-3">

                                    </div>
                                    <div class="col-md-1"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            @*<div class="row">
                    <div class="col-md-6" id="divRebate">
                        <div class="panel panel-success">
                            <div class="panel-heading">Rebate</div>
                            <div class="panel-body">
                                <table class="table table-hover table-bordered" id="tblRebate">
                                    <tr>
                                        <th>Rebate for</th>
                                        <th>Qty</th>
                                        <th>Amount</th>
                                        <th>Rebate</th>
                                        <th>Type</th>
                                        <th>Rebate Amount</th>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6" id="divGift">
                        <div class="panel panel-success">
                            <div class="panel-heading">Gift</div>
                            <div class="panel-body">
                                <table class="table table-hover table-bordered" id="tblGift">
                                    <tr>
                                        <th>Gift for</th>
                                        <th>Qty</th>
                                        <th>Gift</th>
                                        <th>Gift Qty</th>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>*@
        </div>

        @*<div class="col-md-3">
                <div class="panel panel-success">
                    <div class="panel-heading">Available Promotions</div>
                    <div class="panel-body" id="available_promotions">

                    </div>
                </div>
            </div>*@
    </div>


    <div class="row">
        <div class="group-box">
            <div class="row">
                <div class="col-md-12">
                    <input type="button" class="k-button" id="btnSaveRequisition" name="btnSaveRequisition" value="Save Information" />
                </div>
            </div>
        </div>
    </div>
</div>
<p>&nbsp;</p>
<script type="text/javascript">

    //date time picker
    //requisition date
    $(document).ready(function () {

        $('#context').addClass('animated zoomIn');
        $("#discount_pcnt").keyup(function () {
            this.value = this.value.replace(/[^0-9\.]/g,'');

        });
        $("#discount_amount").keyup(function () {
            this.value = this.value.replace(/[^0-9\.]/g,'');

        });

        $('#discount_pcnt').live("keypress", function(e) {
            if (e.keyCode == 13) {

                var discountPcnt= $("#discount_pcnt").val();

                var amountWithVat= $('#amount_with_vat').val();
                var xx = amountWithVat * discountPcnt / 100;

                $("#discount_amount").val(xx);
                $("#net_amount").val(amountWithVat-xx);
            }
        });
        $('#discount_amount').live("keypress", function(e) {
            if (e.keyCode == 13) {

                var discountAmount= $("#discount_amount").val();

                var amountWithVat= $('#amount_with_vat').val();
                var xx = discountAmount / amountWithVat * 100;

                $("#discount_pcnt").val(xx);
                $("#net_amount").val(amountWithVat-discountAmount);

            }
        });

        $("#paid_amount").keyup(function () {
            this.value = this.value.replace(/[^0-9\.]/g,'');

        });

        $('#paid_amount').live("keypress", function(e) {
            if (e.keyCode == 13) {

                var paidAmount= $("#paid_amount").val();

                var netAmount= $('#net_amount').val();
                var xx = paidAmount - netAmount ;

                $("#return_amount").val(xx);

            }
        });

        //warehouse list
        $("#from_warehouse_id").kendoComboBox({
            autoBind: true,
            placeholder: "--- Select Warehouse ---",
            dataTextField: "warehouse_name",
            dataValueField: "warehouse_id",
            dataSource: {
                type: "json",
                transport: {
                    read: {
                        url: "@UrlConfig.Action("GetWarehouseByPartyId", "Warehouse")?party_id="+partyId+""
                    }
                }
            },
            index: 0
        });


        if (partyTypeId != 1) {
            $("#from_warehouse_id").kendoComboBox({enable: false});
        }

        $("#from_warehouse_id").data("kendoComboBox").select(1);

        //party type dropdown
        $("#party_type_id").kendoComboBox({
            autoBind: true,
            placeholder: "--- Select Party Type ---",
            dataTextField: "party_type_name",
            dataValueField: "party_type_id",
            dataSource: {
                type: "json",
                transport: {
                    read: {
                        url: "@UrlConfig.Action("GetNormalClientPartyType", "PartyType")"
                    }
                }
            },
            index: 0
        });

        //party dropdown
        $("#party_id").kendoComboBox({
            autoBind: true,
            placeholder: "--- Select Party ---",
            dataTextField: "party_name",
            dataValueField: "party_id",
            dataSource: {
                type: "json",
                transport: {
                    read: {
                        url: "@UrlConfig.Action("GetOnlyNormalClientParty", "Party")"
                    }
                }
            },
            index: 0
        });


        //to warehouse list
        $("#to_warehouse_id").kendoComboBox({
            autoBind: true,
            placeholder: "--- Select Warehouse ---",
            dataTextField: "warehouse_name",
            dataValueField: "warehouse_id",
            dataSource: {
                type: "json",
                transport: {
                    read: {
                        url: "@UrlConfig.Action("GetSalesWarehouseOnly", "Warehouse")"
                    }
                }
            },
            index: 0
        });

        ////Meraj: 04/10/2016
        //if (partyTypeId != 1) {
        //    $("#party_type_id").kendoComboBox({enable: false});
        //    $("#party_id").kendoComboBox({enable: false});
        //    $("#to_warehouse_id").kendoComboBox({enable: false});
        //}


        $("#party_type_id").kendoComboBox({enable: false});
        $("#party_id").kendoComboBox({enable: false});
        $("#to_warehouse_id").kendoComboBox({enable: false});
        $("#from_warehouse_id").kendoComboBox({enable: false});



        //Meraj this for IMEI Scan and load grid------------------------

        var sampleData = [];

        function checkDuplicateImei(hayStack, imei_no) {
            if (!hayStack) {
                return false;
            } else {
                for (var i = 0; i < hayStack.length; i++) {
                    if (hayStack[i].imei_no == imei_no) {
                        return true;
                    }
                }
                return false;
            }
        }

        $('#daynamicPanel :input').live('keyup', function(e) {

            if(e.keyCode === 13)
            {
                $(this).trigger("enterKey");
                var id = this.id;
                var imei_no =$('#scan_imei').val();
                //var party_id =partyId;
                Loading(true);
                $.ajax({
                    type: "GET",
                    url: "@UrlConfig.Action("GetProductInformationForCentral", "ReceiveSerialNoDetails")?imei_no="+imei_no+"",
                    dataType: "json",
                    contentType: "application/json",
                    success: function (data) {
                        Loading(false);

                        if (data !='') {

                            for (var i = 0; i < data.length; i++) {
                                var productDetails = {
                                    receive_serial_no_details_id: data[i].receive_serial_no_details_id,
                                    product_id: data[i].product_id,
                                    product_name: data[i].product_name,
                                    color_id: data[i].color_id,
                                    color_name: data[i].color_name,
                                    price: data[i].price,
                                    discount: 0,
                                    line_total:data[i].price-0,
                                    imei_no: data[i].imei_no
                                };
                                var isDuplicate = checkDuplicateImei(sampleData,imei_no);
                                if (isDuplicate) {
                                    swal("Exception", "IMEI already in list !!", "warning");
                                } else {
                                    sampleData.push(productDetails);
                                }

                            }
                            console.log(sampleData);

                            //productList Grid---------------------

                            // custom logic start

                            var sampleDataNextID = sampleData.length + 1;

                            function getIndexById(id) {
                                var idx,
                                    l = sampleData.length;

                                for (var j = 0; j < l; j++) {
                                    if (sampleData[j].receive_serial_no_details_id == id) {
                                        return j;
                                    }
                                }
                                return null;
                            }

                            // custom logic end

                            var dataSource = new kendo.data.DataSource({
                                transport: {
                                    read: function (e) {
                                        // on success
                                        e.success(sampleData);
                                        //console.log(sampleData);

                                        var totalNumber = sampleData.length;

                                        var amount = 0;

                                        for (var i = 0; i < totalNumber; i++) {

                                            amount += +parseFloat(sampleData[i].line_total).toFixed(2);

                                        }
                                        $("#amount").val(amount);
                                        var vatPcnt = $("#vat_pcnt").val();
                                        var amount_with_vat = amount * vatPcnt / 100;
                                        $("#amount_with_vat").val(amount+amount_with_vat);
                                        $("#net_amount").val(amount+amount_with_vat);
                                    },
                                    create: function (e) {
                                        //// assign an ID to the new item
                                        //e.data.receive_serial_no_details_id = sampleDataNextID++;
                                        //// save data item to the original datasource

                                        //var gridData = sampleData;
                                        //var totalNumber = gridData.length;
                                        //var count = 0;

                                        //for (var i = 0; i < totalNumber; i++) {
                                        //    var productId = gridData[i].product_id;
                                        //    var colorId = gridData[i].color_id;
                                        //    if (e.data.product_id === productId && e.data.color_id === colorId) {
                                        //        count++;
                                        //    }
                                        //}
                                        //if (count > 0) {
                                        //    sweetAlert("Sorry...", "Selected Product is Duplicate !!!", "warning");
                                        //    e.preventDefault();
                                        //    return false;
                                        //} else {
                                        //    sampleData.push(e.data);
                                        //    e.success(e.data);
                                        //    getRebateAndGiftInfo();
                                        //    console.log(sampleData);
                                        //    return true;
                                        //}

                                    },
                                    update: function (e) {
                                        // locate item in original datasource and update it
                                        sampleData[getIndexById(e.data.receive_serial_no_details_id)] = e.data;
                                        //getRebateAndGiftInfo();
                                        e.success();

                                    },
                                    destroy: function (e) {
                                        // locate item in original datasource and remove it
                                        // var requisitionDetailsId=e.data.requisition_details_id;

                                        sampleData.splice(getIndexById(e.data.receive_serial_no_details_id), 1);

                                        @*$.ajax({
                                        type: "GET",
                                        url: "@UrlConfig.Action("DeleteRequisitionDetails", "Requisition")",
                                        data: {
                                        requisition_details_id: requisitionDetailsId
                                        },
                                    dataType: "json",
                                    contentType: "application/json",
                                    success: function (data) {
                                        Loading(false);
                                        console.log(data);
                                        if (data.output === "success") {


                                            swal("Success", data.msg, "success");
                                            return false;
                                        } else {
                                            swal("Exception", data.msg, "error");
                                            return false;
                                        }
                                    }
                                });*@

                                        // on success
                                        e.success();
                                        var entityGrid = $("#RequisitionDetailsGrid").data("kendoGrid");
                                        var gridData = entityGrid.dataSource.data();
                                        var totalNumber = gridData.length;

                                        var amount = 0;

                                        for (var i = 0; i < totalNumber; i++) {

                                            amount += +parseFloat(gridData[i].line_total).toFixed(2);

                                        }
                                        $("#amount").val(amount);
                                        var vatPcnt = $("#vat_pcnt").val();
                                        var amount_with_vat = amount * vatPcnt / 100;
                                        $("#amount_with_vat").val(amount+amount_with_vat);
                                        $("#net_amount").val(amount+amount_with_vat);
                                        //console.log(gridData);
                                    }
                                },
                                error: function (e) {
                                    // handle data operation error
                                    alert("Status: " + e.status + "; Error message: " + e.errorThrown);
                                },
                                pageSize: 10,
                                batch: false,
                                schema: {
                                    model: {
                                        id: "receive_serial_no_details_id",
                                        fields: {
                                            receive_serial_no_details_id: { editable: false, nullable: true },
                                            product_id: { field: "product_id", type: "integer" },
                                            product_name: { type: "string" },
                                            color_id: { field: "color_id", type: "integer" },
                                            color_name: { type: "string" },
                                            imei_no: { type: "string" },
                                            price: { type: "string" },
                                            discount: { type: "string", editable: true },
                                            line_total: { type: "string", editable: true }

                                        }
                                    }
                                }
                            });



                            $("#RequisitionDetailsGrid").kendoGrid({
                                dataSource: dataSource,
                                pageable: true,
                                // toolbar: ["create"],
                                selectable: true,
                                save: function (data) {

                                    var tempAmount = +data.model.price - +data.model.discount;
                                    data.model.set("line_total", tempAmount);


                                    var entityGrid = $("#RequisitionDetailsGrid").data("kendoGrid");
                                    var gridData = entityGrid.dataSource.data();
                                    var totalNumber = gridData.length;

                                    var amount = 0;

                                    for (var i = 0; i < totalNumber; i++) {
                                        amount += +parseFloat(gridData[i].line_total).toFixed(2);
                                    }

                                    $("#amount").val(amount);
                                    var vatPcnt = $("#vat_pcnt").val();
                                    var amount_with_vat = amount * vatPcnt / 100;
                                    $("#amount_with_vat").val(amount+amount_with_vat);
                                    $("#net_amount").val(amount+amount_with_vat);

                                },
                                edit: function (e) {

                                    $('input[name="line_total"]').attr('readonly', 'readonly');
                                    $('input[name="price"]').attr('readonly', 'readonly');

                                },
                                cancel: function(data) {

                                    var tempAmount = +data.model.quantity * +data.model.price;
                                    data.model.set("lineTotal", tempAmount);


                                    var gridData = sampleData;
                                    var totalNumber = gridData.length;


                                    console.log(sampleData);

                                },
                                columns: [
                                    { field: "product_id", title: "Product", template: "#= product_name #", editor: productDropDownEditor, width: "50px" },
                                    { field: "color_id", title: "Color", template: "#= color_name #", editor: colorDropDownEditor, width: "50px" },
                                    { field: "imei_no", title: "IMEI", width: "50px" },
                                    { field: "price", title: "Price", width: "50px" },
                                    { field: "discount", title: "Discount", width: "50px" },
                                    { field: "line_total", title: "Line Total", width: "50px" },
                                    { command: ["edit", "destroy"], title: "&nbsp;", width: "110px" }
                                ],
                                editable: "inline"
                            });


                            var len = $("#RequisitionDetailsGrid").find("tbody tr").length;
                            for(var j=0;j<=len ; j++)
                            {
                                var model = $("#RequisitionDetailsGrid").data("kendoGrid").dataSource.at(j);
                                if (model) {//field names
                                    model.fields["product_id"].editable = false;
                                    model.fields["color_id"].editable = false;
                                    model.fields["imei_no"].editable = false;
                                    //model.fields["price"].editable = false;
                                    //model.fields["line_total"].editable = false;

                                }

                            }

                            //template for product comboBox
                            function productDropDownEditor(container, options) {
                                jQuery('<input required data-text-field="product_name" data-value-field="product_id" data-bind="value:' + options.field + '"/>')
                                    .appendTo(container)

                                    .kendoComboBox({
                                        autoBind: true,
                                        placeholder: "-Select-",
                                        dataSource: {
                                            transport: {
                                                read: {
                                                    url: "@UrlConfig.Action("GetAllProducts", "Product")",
                                                    type: "GET"
                                                }
                                            }

                                        },

                                        change: function (e) {
                                            var dataItem = this.dataItem(e.item);

                                            console.log(dataItem.product_name);
                                            var grid = $("#RequisitionDetailsGrid").data("kendoGrid");
                                            var sel = grid.select();
                                            var sel_idx = sel.index();
                                            var gridData = grid.dataSource.data();
                                            gridData[sel_idx].product_id = dataItem.product_id,
                                                gridData[sel_idx].product_name = dataItem.product_name;
                                            gridData[sel_idx].color_id = dataItem.color_id,
                                                gridData[sel_idx].color_name = dataItem.color_name;
                                            gridData[sel_idx].unit_id = dataItem.unit_id;
                                            gridData[sel_idx].unit_name = dataItem.unit_name;
                                            gridData[sel_idx].brand_id = dataItem.brand_id;
                                            gridData[sel_idx].brand_name = dataItem.brand_name;
                                            gridData[sel_idx].product_category_id = dataItem.product_category_id;
                                            gridData[sel_idx].product_category_name = dataItem.product_category_name;

                                            if (partyTypeId==1) {
                                                gridData[sel_idx].price = dataItem.rp_price;
                                            }
                                            if (partyTypeId==2) {
                                                gridData[sel_idx].price = dataItem.md_price;
                                            }
                                            if (partyTypeId==3) {
                                                gridData[sel_idx].price = dataItem.bs_price;
                                            }

                                        }
                                    });
                            }


                            //template for color comboBox
                            function colorDropDownEditor(container, options) {
                                jQuery('<input required data-text-field="color_name" data-value-field="color_id" data-bind="value:' + options.field + '"/>')
                                    .appendTo(container)

                                    .kendoComboBox({
                                        autoBind: true,
                                        placeholder: "-Select-",
                                        dataSource: {
                                            transport: {
                                                read: {
                                                    url: "@UrlConfig.Action("GetAllColors", "Color")",
                                                    type: "GET"
                                                }
                                            }

                                        },

                                        change: function (e) {
                                            var dataItem = this.dataItem(e.item);

                                            console.log(dataItem.product_name);
                                            var grid = $("#RequisitionDetailsGrid").data("kendoGrid");
                                            var sel = grid.select();
                                            var sel_idx = sel.index();
                                            var gridData = grid.dataSource.data();
                                            gridData[sel_idx].color_id = dataItem.color_id,
                                                gridData[sel_idx].color_name = dataItem.color_name;


                                        }
                                    });
                            }

                            //productList Grid---------------------



                            //return false;
                        } else {
                            swal("Exception", "Product Not Available !!", "error");
                            return false;
                        }
                    }
                });

                $("#" + id + "").val("");
            }
        });
        //--------------------------------------------------------------




        @*//productList Grid---------------------
        var sampleData = [];

        // custom logic start

        var sampleDataNextID = sampleData.length + 1;

        function getIndexById(id) {
            var idx,
                l = sampleData.length;

            for (var j = 0; j < l; j++) {
                if (sampleData[j].requisition_details_id == id) {
                    return j;
                }
            }
            return null;
        }

        // custom logic end

        var dataSource = new kendo.data.DataSource({
            transport: {
                read: function (e) {
                    e.success(sampleData);
                },
                create: function (e) {

                    // assign an ID to the new item
                    e.data.requisition_details_id = sampleDataNextID++;
                    // save data item to the original datasource

                    var gridData = sampleData;
                    var totalNumber = gridData.length;
                    var count = 0;

                    for (var i = 0; i < totalNumber; i++) {
                        var productId = gridData[i].product_id;
                        var colorId = gridData[i].color_id;
                        if (e.data.product_id === productId && e.data.color_id === colorId) {
                            count++;
                        }
                    }
                    if (count > 0) {
                        sweetAlert("Sorry...", "Selected Product is Duplicate !!!", "warning");
                        //e.preventDefault();
                        return false;
                    } else {
                        sampleData.push(e.data);
                        e.success(e.data);
                        //console.log(sampleData);
                        getRebateAndGiftInfo();
                        return true;
                    }


                },
                update: function (e) {
                    // locate item in original datasource and update it
                    sampleData[getIndexById(e.data.requisition_details_id)] = e.data;
                    e.success();
                    getRebateAndGiftInfo();

                },
                destroy: function (e) {
                    // locate item in original datasource and remove it
                    sampleData.splice(getIndexById(e.data.requisition_details_id), 1);
                    // on success
                    e.success();
                    var entityGrid = $("#RequisitionDetailsGrid").data("kendoGrid");
                    var gridData = entityGrid.dataSource.data();
                    var totalNumber = gridData.length;


                }
            },
            error: function (e) {
                // handle data operation error
                alert("Status: " + e.status + "; Error message: " + e.errorThrown);
            },
            pageSize: 10,
            batch: false,
            schema: {
                model: {
                    id: "requisition_details_id",
                    fields: {
                        requisition_details_id: { editable: false, nullable: true },
                        product_id: { field: "product_id", type: "integer" },
                        product_name: { type: "string" },
                        product_category_id: { field: "product_category_id", type: "integer" },
                        product_category_name: { type: "string" , editable: false},
                        unit_id: { field: "unit_id", type: "integer" },
                        unit_name: { type: "string" },
                        brand_id: { field: "brand_id", type: "integer" },
                        brand_name: { type: "string", editable: false },
                        quantity: { type: "number" },
                        color_id: { field: "color_id", type: "integer" },
                        color_name: { type: "string" },
                        price: { type: "number" },
                        line_total: { type: "string" }

                    }
                }
            }
        });



        function getRebateAndGiftInfo() {
            var is_active_promo = true;
            var requisitionDetailsList = [];
            var requisitionDetailsGrid = $("#RequisitionDetailsGrid").data("kendoGrid").dataSource.data();

            console.log(requisitionDetailsGrid);
            for (var i = 0; i < requisitionDetailsGrid.length; i++) {
                var requisitionDetails = {
                    requisition_master_id: '@ViewBag.requisition_master_id',
                    requisition_details_id: requisitionDetailsGrid[i].requisition_details_id,
                    product_id: requisitionDetailsGrid[i].product_id,
                    product_name: requisitionDetailsGrid[i].product_name,
                    unit_id: requisitionDetailsGrid[i].unit_id,
                    brand_id: requisitionDetailsGrid[i].brand_id,
                    product_category_id: requisitionDetailsGrid[i].product_category_id,
                    price: requisitionDetailsGrid[i].price,
                    quantity: requisitionDetailsGrid[i].quantity,
                    color_id: requisitionDetailsGrid[i].color_id,
                    line_total: requisitionDetailsGrid[i].line_total
                };
                requisitionDetailsList.push(requisitionDetails);
            }
            Loading(true);

            var getRebateAndGiftInfoModel = {
                RequisitionDetailsList: requisitionDetailsList,
                IsActivePromo: is_active_promo
            };



            $.ajax({
                type: "POST",
                url: "@UrlConfig.Action("GetRebateAndGiftInfo", "Requisition")",
                data: JSON.stringify(getRebateAndGiftInfoModel),
                async:true,
                dataType: "json",
                contentType: "application/json",
                success: function (data) {
                    Loading(false);
                    console.log(data.rebateList);
                    console.log(data.giftList);


                    $('#tblRebate tr').has('td').remove();
                    $('#tblGift tr').has('td').remove();

                    //display for rebate table
                    $.each(data.rebateList, function(value, obj) {
                        var rebateData = "";
                        rebateData += "<tr id='"+obj.rebate_for+"'>";
                        rebateData += "<td>"+obj.rebate_for+"</td>";
                        rebateData += "<td>"+obj.quantity+"</td>";
                        rebateData += "<td>"+obj.amount+"</td>";
                        rebateData += "<td>"+obj.rebate+"</td>";
                        rebateData += "<td>"+obj.rebate_type+"</td>";
                        rebateData += "<td>"+obj.rebate_amount+"</td>";
                        rebateData += "</tr>";

                        $("#tblRebate tr:last").after(rebateData);


                    });

                    //display for gift table
                    $.each(data.giftList, function(value, obj) {
                        var giftData = "";

                        giftData += "<tr id='"+obj.gift_for.split(' ').join('_')+"'>";
                        giftData += "<td>" + obj.gift_for + "</td>";
                        giftData += "<td>" + obj.gift_quantity_for + "</td>";
                        giftData += "<td>" + obj.gift_for + "</td>";
                        giftData += "<td>" + obj.gift_quantity + "</td>";
                        giftData += "</tr>";

                        $("#tblGift tr:last").after(giftData);


                    });
                }
            });
        }

        $("#RequisitionDetailsGrid").kendoGrid({
            dataSource: dataSource,
            pageable: true,
            toolbar: ["create"],
            selectable: true,
            save: function (data) {

                var amount = 0;
                var tempAmount = +data.model.quantity * +data.model.price;
                data.model.set("line_total", tempAmount);

                //var lineTotal = +data.model.vat_amount + +data.model.tax_amount;

                var entityGrid = $("#RequisitionDetailsGrid").data("kendoGrid");
                var gridData = entityGrid.dataSource.data();
                var totalNumber = gridData.length;

                for (var i = 0; i < totalNumber; i++) {
                    amount += +parseFloat(gridData[i].line_total).toFixed(2);
                }

                $("#amount").val(amount);




            },

            cancel: function(data) {
                var tempAmount = +data.model.quantity * +data.model.price;
                data.model.set("line_total", tempAmount);

                var gridData = sampleData;
                var totalNumber = gridData.length;
                console.log(sampleData);

            },
            columns: [
                { field: "product_id", title: "Product", template: "#= product_name #", editor: productDropDownEditor, width: "50px" },
                { field: "color_id", title: "Color", template: "#= color_name #", editor: colorDropDownEditor, width: "50px" },
                { field: "quantity", title: "Quantity", width: "50px" },
                { field: "price", title: "Price", width: "50px" },
                { field: "line_total", title: "Line Total", width: "50px" },
                { command: ["edit", "destroy"], title: "&nbsp;", width: "110px" }
            ],
            editable: "inline"
        });


        //template for product comboBox
        function productDropDownEditor(container, options) {
            jQuery('<input required data-text-field="product_name" data-value-field="product_id" data-bind="value:' + options.field + '"/>')
                .appendTo(container)

                .kendoComboBox({
                    autoBind: false,
                    placeholder: "-Select-",
                    dataSource: {
                        transport: {
                            read: {
                                url: "@UrlConfig.Action("GetAllProducts", "Product")",
                                type: "GET"
                            }
                        }

                    },

                    change: function (e) {
                        var dataItem = this.dataItem(e.item);

                        console.log(dataItem.product_name);
                        var grid = $("#RequisitionDetailsGrid").data("kendoGrid");
                        var sel = grid.select();
                        var sel_idx = sel.index();
                        var gridData = grid.dataSource.data();
                        gridData[sel_idx].product_id = dataItem.product_id,
                        gridData[sel_idx].product_name = dataItem.product_name;
                        gridData[sel_idx].unit_id = dataItem.unit_id;
                        gridData[sel_idx].unit_name = dataItem.unit_name;
                        gridData[sel_idx].brand_id = dataItem.brand_id;
                        gridData[sel_idx].brand_name = dataItem.brand_name;
                        gridData[sel_idx].product_category_id = dataItem.product_category_id;
                        gridData[sel_idx].product_category_name = dataItem.product_category_name;

                        if (partyTypeId==1) {
                            gridData[sel_idx].price = dataItem.rp_price;
                        }
                        if (partyTypeId==2) {
                            gridData[sel_idx].price = dataItem.md_price;
                        }
                        if (partyTypeId==3) {
                            gridData[sel_idx].price = dataItem.bs_price;
                        }


                    }
                });
        }


        //template for color comboBox
        function colorDropDownEditor(container, options) {
            jQuery('<input required data-text-field="color_name" data-value-field="color_id" data-bind="value:' + options.field + '"/>')
                .appendTo(container)

                .kendoComboBox({
                    autoBind: false,
                    placeholder: "-Select-",
                    dataSource: {
                        transport: {
                            read: {
                                url: "@UrlConfig.Action("GetAllColors", "Color")",
                                type: "GET"
                            }
                        }

                    },

                    change: function (e) {
                        var dataItem = this.dataItem(e.item);

                        console.log(dataItem.product_name);
                        var grid = $("#RequisitionDetailsGrid").data("kendoGrid");
                        var sel = grid.select();
                        var sel_idx = sel.index();
                        var gridData = grid.dataSource.data();
                        gridData[sel_idx].color_id = dataItem.color_id,
                        gridData[sel_idx].color_name = dataItem.color_name;


                    }
                });
        }

        //productList Grid---------------------*@
        @*function posInvoiceReport(pos_master_id) {
             //e.preventDefault();
             //var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
             //var returnDetailsId = dataItem.return_details_id;
             $.ajax({
                 type: "GET",
                 url: "@UrlConfig.Action("PosInvoiceReportById", "Pos")",
                 data: { pos_master_id: posMasterId },//Passing parameter
                 dataType: "json",
                 contentType: "application/json",
                 success: function (data) {
                 Loading(false);
                 //console.log(data);
                 if (data.output === "success") {
                     swal("Success", data.msg, "success");
                     return false;
                 } else {
                     swal("Exception", data.msg, "error");
                     return false;
                 }
             }
         });

    }*@

        $("#btnSaveRequisition").click(function () {
            var newWindow = window.open("","_blank");
            newWindow.blur();
            Loading(true);

            var party_type_id = $('#party_type_id').val();
            var party_id = $('#party_id').val();
            var customer_name = $('#customer_name').val();
            var address = $('#address').val();
            var mobile_no=$('#mobile_no').val();
            var from_warehouse_id = $('#from_warehouse_id').val();
            var to_warehouse_id=$('#to_warehouse_id').val();
            var remarks = $('#remarks').val();
            //var created_by = userId;
            //var owner_party_id = partyId;

            var amount = $('#amount').val();
            var vat_pcnt = $('#vat_pcnt').val();
            var amount_with_vat = $('#amount_with_vat').val();
            var discount_pcnt = $('#discount_pcnt').val();
            var discount_amount = $('#discount_amount').val();
            var net_amount = $('#net_amount').val();
            var paid_amount = $('#paid_amount').val();
            var return_amount = $('#return_amount').val();
            //var status = $('#status').val();


            var PosMasterData = {
                party_type_id: party_type_id,
                party_id: party_id,
                customer_name: customer_name,
                address: address,
                mobile_no: mobile_no,
                from_warehouse_id: from_warehouse_id,
                to_warehouse_id: to_warehouse_id,
                amount: amount,
                vat_pcnt: vat_pcnt,
                amount_with_vat: amount_with_vat,
                discount_pcnt: discount_pcnt,
                discount_amount: discount_amount,
                net_amount: net_amount,
                paid_amount: paid_amount,
                return_amount: return_amount,

                remarks: remarks,
                created_by: userId,
                owner_party_id: @partyId
                };

            var ProductDetailsList = [];
            var ProductDetailsGrid = $("#RequisitionDetailsGrid").data("kendoGrid").dataSource.data();
            for (var i = 0; i < ProductDetailsGrid.length; i++) {
                var productDetails = {

                    product_id: ProductDetailsGrid[i].product_id,
                    color_id: ProductDetailsGrid[i].color_id,
                    imei_no: ProductDetailsGrid[i].imei_no,
                    price: ProductDetailsGrid[i].price,
                    discount: ProductDetailsGrid[i].discount,
                    line_total: ProductDetailsGrid[i].line_total

                };
                ProductDetailsList.push(productDetails);
            }

            var PosModel = {
                PosMasterData: PosMasterData,
                PosDetailsList: ProductDetailsList
            };

            $.ajax({
                type: "POST",
                url: "@UrlConfig.Action("Post", "Pos")",
                data: JSON.stringify(PosModel),
                dataType: "json",
                contentType: "application/json",
                success: function (data) {
                    Loading(false);
                    //console.log(ProductDetailsGrid);
                    if (data.output === "success") {
                        //console.log(data.returnvalue);
                        //var posMasterId = data.returnvalue.pos_master_id;
                        //posInvoiceReport(posMasterId);
                            //var posMasterId = data.returnvalue.pos_master_id;
                            //var url = "/CentralPointOfSale/GetPosInvoiceReport?pos_master_id=" + posMasterId;
                            //window.open(url, '_blank');
                     
                            
                        var pos_master_id = data.returnvalue.pos_master_id;
                        var url = "/CentralPointOfSale/GetPosInvoiceReport?pos_master_id=" + pos_master_id;
                        //window.open(url, '_blank');
                        newWindow.location.href = url;
                        newWindow.focus();
                       
                        

                        swal("Success", data.msg, "success");
                        window.location.href = '/CentralPointOfSale/index';
                        return false;
                    } else {
                        swal("Exception", data.msg, "error");
                        return false;
                    }
                }
            });

        });

    });


</script>
